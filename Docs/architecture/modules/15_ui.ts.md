# ui.ts Architecture

> **Source File**: [`src/lib/utils/ui.ts`](../../../src/lib/utils/ui.ts)
> **Status**: ✅ Implemented
> **Module Type**: Utility Functions - UI Helpers
> **Lines of Code**: 641

---

## Table of Contents

- [Overview](#overview)
- [Animation Utilities](#animation-utilities)
- [DOM Utilities](#dom-utilities)
- [Color Utilities](#color-utilities)
- [Format Utilities](#format-utilities)
- [Clipboard Utilities](#clipboard-utilities)
- [Keyboard Utilities](#keyboard-utilities)
- [Notification Utilities](#notification-utilities)
- [Platform Detection](#platform-detection)
- [Async Utilities](#async-utilities)
- [Related Documentation](#related-documentation)

---

## Overview

`ui.ts` provides a comprehensive collection of UI utility functions for Skretchpad. It includes 40+ pure functions for animations, DOM manipulation, color operations, formatting, clipboard access, keyboard handling, platform detection, and async operations.

### Key Features

- **Animation**: Easing functions, RAF-based animations, spring physics
- **DOM**: Viewport detection, scrolling, focus management
- **Color**: Parsing, conversion, luminance, contrast calculations
- **Format**: File sizes, relative time, durations, path truncation
- **Clipboard**: Copy/paste operations
- **Keyboard**: Shortcut formatting, modifier detection
- **Platform**: OS detection (macOS, Windows, Linux)
- **Async**: Sleep, retry, timeout utilities

---

## Animation Utilities

### Easing Functions

#### easeInOutCubic

```typescript
export function easeInOutCubic(t: number): number
```

**Source**: Lines 14-16

Cubic easing for smooth start and end.

**Example**:
```typescript
const progress = easeInOutCubic(0.5); // 0.5
```

#### easeOutExpo

```typescript
export function easeOutExpo(t: number): number
```

**Source**: Lines 21-23

Exponential easing for fast start, slow end.

#### easeInOutExpo

```typescript
export function easeInOutExpo(t: number): number
```

**Source**: Lines 28-33

Exponential easing for smooth start and end.

### animate

```typescript
export function animate(
  from: number,
  to: number,
  duration: number,
  onUpdate: (value: number) => void,
  easing: (t: number) => number = easeInOutCubic
): () => void
```

**Source**: Lines 38-65

Animates a value over time using requestAnimationFrame.

**Parameters**:
- `from` - Starting value
- `to` - Target value
- `duration` - Animation duration in ms
- `onUpdate` - Callback for each frame
- `easing` - Easing function (default: easeInOutCubic)

**Returns**: Cancel function

**Example**:
```typescript
const cancel = animate(0, 100, 1000, (value) => {
  element.style.opacity = value / 100;
});

// Cancel early if needed
// cancel();
```

### spring

```typescript
export function spring(
  from: number,
  to: number,
  stiffness = 0.15,
  damping = 0.8,
  onUpdate: (value: number) => void
): () => void
```

**Source**: Lines 70-100

Spring physics animation with stiffness and damping.

**Parameters**:
- `from` - Starting value
- `to` - Target value
- `stiffness` - Spring stiffness (0-1, default: 0.15)
- `damping` - Damping factor (0-1, default: 0.8)
- `onUpdate` - Callback for each frame

**Returns**: Cancel function

**Example**:
```typescript
spring(0, 100, 0.2, 0.7, (value) => {
  element.style.transform = `translateX(${value}px)`;
});
```

---

## DOM Utilities

### isInViewport

```typescript
export function isInViewport(element: HTMLElement): boolean
```

**Source**: Lines 109-117

Checks if element is fully visible in viewport.

**Example**:
```typescript
if (isInViewport(targetElement)) {
  console.log('Element is visible');
}
```

### scrollIntoView

```typescript
export function scrollIntoView(
  element: HTMLElement,
  options: ScrollIntoViewOptions = { behavior: 'smooth', block: 'center' }
): void
```

**Source**: Lines 122-127

Smoothly scrolls element into view.

### getElementPosition

```typescript
export function getElementPosition(element: HTMLElement): {
  top: number;
  left: number;
  width: number;
  height: number;
}
```

**Source**: Lines 132-145

Gets element position relative to viewport.

### hasOverflow

```typescript
export function hasOverflow(element: HTMLElement): {
  x: boolean;
  y: boolean;
}
```

**Source**: Lines 150-158

Checks if element content overflows.

**Example**:
```typescript
const overflow = hasOverflow(container);
if (overflow.y) {
  container.classList.add('scrollable');
}
```

### getScrollbarWidth

```typescript
export function getScrollbarWidth(): number
```

**Source**: Lines 163-177

Calculates browser scrollbar width by creating temporary elements.

**Returns**: Scrollbar width in pixels

### trapFocus

```typescript
export function trapFocus(element: HTMLElement): () => void
```

**Source**: Lines 182-215

Traps keyboard focus within an element (useful for modals).

**Returns**: Cleanup function

**Example**:
```typescript
const modal = document.querySelector('.modal');
const cleanup = trapFocus(modal);

// When modal closes:
// cleanup();
```

---

## Color Utilities

### hexToRgb

```typescript
export function hexToRgb(hex: string): { r: number; g: number; b: number } | null
```

**Source**: Lines 224-233

Converts hex color to RGB object.

**Example**:
```typescript
hexToRgb('#ff6b6b'); // { r: 255, g: 107, b: 107 }
```

### rgbToHex

```typescript
export function rgbToHex(r: number, g: number, b: number): string
```

**Source**: Lines 238-243

Converts RGB values to hex string.

**Example**:
```typescript
rgbToHex(255, 107, 107); // "#ff6b6b"
```

### parseColor

```typescript
export function parseColor(color: string): {
  r: number;
  g: number;
  b: number;
  a: number;
} | null
```

**Source**: Lines 248-272

Parses CSS color string (hex, rgb, rgba) to RGBA object.

**Example**:
```typescript
parseColor('#ff6b6b');        // { r: 255, g: 107, b: 107, a: 1 }
parseColor('rgb(255, 107, 107)'); // { r: 255, g: 107, b: 107, a: 1 }
parseColor('rgba(255, 107, 107, 0.5)'); // { r: 255, g: 107, b: 107, a: 0.5 }
```

### getLuminance

```typescript
export function getLuminance(color: string): number
```

**Source**: Lines 277-290

Calculates relative luminance using WCAG formula.

**Returns**: Luminance value (0-1)

### isDark

```typescript
export function isDark(color: string): boolean
```

**Source**: Lines 295-297

Checks if color is dark (luminance < 0.5).

**Example**:
```typescript
isDark('#000000'); // true
isDark('#ffffff'); // false
```

### getContrastRatio

```typescript
export function getContrastRatio(color1: string, color2: string): number
```

**Source**: Lines 302-308

Calculates WCAG contrast ratio between two colors.

**Returns**: Contrast ratio (1-21)

**Example**:
```typescript
const ratio = getContrastRatio('#000000', '#ffffff'); // 21 (maximum)
const isReadable = ratio >= 4.5; // WCAG AA requirement
```

### lighten

```typescript
export function lighten(color: string, amount: number): string
```

**Source**: Lines 313-323

Lightens a color by specified amount.

**Parameters**:
- `color` - CSS color string
- `amount` - Lighten amount (0-1)

**Example**:
```typescript
lighten('#ff6b6b', 0.2); // Lighter shade
```

### darken

```typescript
export function darken(color: string, amount: number): string
```

**Source**: Lines 328-338

Darkens a color by specified amount.

### withAlpha

```typescript
export function withAlpha(color: string, alpha: number): string
```

**Source**: Lines 343-349

Adds alpha channel to color.

**Example**:
```typescript
withAlpha('#ff6b6b', 0.5); // "rgba(255, 107, 107, 0.5)"
```

---

## Format Utilities

### formatFileSize

```typescript
export function formatFileSize(bytes: number): string
```

**Source**: Lines 358-366

Formats byte count as human-readable file size.

**Example**:
```typescript
formatFileSize(1024);      // "1 KB"
formatFileSize(1048576);   // "1 MB"
formatFileSize(1073741824); // "1 GB"
```

### formatRelativeTime

```typescript
export function formatRelativeTime(timestamp: number): string
```

**Source**: Lines 371-392

Formats timestamp as relative time ("2 hours ago").

**Example**:
```typescript
const twoHoursAgo = Date.now() - (2 * 60 * 60 * 1000);
formatRelativeTime(twoHoursAgo); // "2 hours ago"
```

### formatDuration

```typescript
export function formatDuration(ms: number): string
```

**Source**: Lines 397-409

Formats milliseconds as readable duration.

**Example**:
```typescript
formatDuration(1000);      // "1s"
formatDuration(61000);     // "1m 1s"
formatDuration(3661000);   // "1h 1m 1s"
```

### truncate

```typescript
export function truncate(str: string, maxLength: number): string
```

**Source**: Lines 414-417

Truncates string with ellipsis.

**Example**:
```typescript
truncate('Hello, world!', 8); // "Hello..."
```

### truncatePath

```typescript
export function truncatePath(path: string, maxLength: number): string
```

**Source**: Lines 422-436

Truncates file path showing start and end.

**Example**:
```typescript
truncatePath('/very/long/path/to/file.txt', 20);
// "/very/.../file.txt"
```

---

## Clipboard Utilities

### copyToClipboard

```typescript
export async function copyToClipboard(text: string): Promise<boolean>
```

**Source**: Lines 445-453

Copies text to system clipboard.

**Returns**: `true` if successful, `false` if failed

**Example**:
```typescript
const success = await copyToClipboard('Hello, clipboard!');
if (success) {
  showNotification('Copied to clipboard');
}
```

### readFromClipboard

```typescript
export async function readFromClipboard(): Promise<string | null>
```

**Source**: Lines 458-465

Reads text from system clipboard.

**Returns**: Clipboard text or `null` if failed

**Example**:
```typescript
const text = await readFromClipboard();
if (text) {
  console.log('Clipboard contents:', text);
}
```

---

## Keyboard Utilities

### isModifierPressed

```typescript
export function isModifierPressed(event: KeyboardEvent): boolean
```

**Source**: Lines 474-476

Checks if any modifier key is pressed.

### getModifierKey

```typescript
export function getModifierKey(): string
```

**Source**: Lines 481-483

Gets platform-appropriate modifier key symbol.

**Returns**: `"⌘"` on macOS, `"Ctrl"` on Windows/Linux

### formatShortcut

```typescript
export function formatShortcut(shortcut: string): string
```

**Source**: Lines 488-503

Formats keyboard shortcut for display with platform-specific symbols.

**Example**:
```typescript
// On macOS:
formatShortcut('Ctrl+S');      // "⌘S"
formatShortcut('Shift+Enter'); // "⇧↵"

// On Windows:
formatShortcut('Ctrl+S');      // "Ctrl+S"
```

**Symbol Mappings**:
- `Ctrl` → `⌘` (macOS) or `Ctrl`
- `Alt` → `⌥` (macOS) or `Alt`
- `Shift` → `⇧` (macOS) or `Shift`
- `Enter` → `↵`
- `Backspace` → `⌫`
- `Delete` → `⌦`
- Arrow keys → `↑↓←→`

---

## Notification Utilities

### NotificationOptions

```typescript
export interface NotificationOptions {
  type?: 'info' | 'success' | 'warning' | 'error';
  duration?: number;
  action?: {
    label: string;
    callback: () => void;
  };
}
```

**Source**: Lines 509-516

### showNotification

```typescript
export function showNotification(
  message: string,
  options: NotificationOptions = {}
): void
```

**Source**: Lines 521-527

Shows notification (placeholder implementation).

**Note**: Current implementation logs to console. Production version would integrate with notification system.

---

## Platform Detection

### isMac

```typescript
export function isMac(): boolean
```

**Source**: Lines 536-538

Checks if running on macOS.

### isWindows

```typescript
export function isWindows(): boolean
```

**Source**: Lines 543-545

Checks if running on Windows.

### isLinux

```typescript
export function isLinux(): boolean
```

**Source**: Lines 550-552

Checks if running on Linux.

### getPlatform

```typescript
export function getPlatform(): 'mac' | 'windows' | 'linux' | 'unknown'
```

**Source**: Lines 557-565

Gets platform name.

**Example**:
```typescript
const platform = getPlatform();
if (platform === 'mac') {
  // macOS-specific code
}
```

---

## Async Utilities

### sleep

```typescript
export function sleep(ms: number): Promise<void>
```

**Source**: Lines 574-576

Sleeps for specified milliseconds.

**Example**:
```typescript
await sleep(1000); // Wait 1 second
console.log('Done waiting');
```

### retry

```typescript
export async function retry<T>(
  fn: () => Promise<T>,
  options: {
    maxAttempts?: number;
    initialDelay?: number;
    maxDelay?: number;
    factor?: number;
  } = {}
): Promise<T>
```

**Source**: Lines 581-614

Retries async operation with exponential backoff.

**Options**:
- `maxAttempts` - Maximum retry attempts (default: 3)
- `initialDelay` - Initial delay in ms (default: 1000)
- `maxDelay` - Maximum delay in ms (default: 10000)
- `factor` - Backoff multiplier (default: 2)

**Example**:
```typescript
const data = await retry(
  () => fetchData(),
  {
    maxAttempts: 5,
    initialDelay: 500,
    maxDelay: 5000,
    factor: 2
  }
);
```

**Backoff Schedule** (default settings):
- Attempt 1: 0ms
- Attempt 2: 1000ms delay
- Attempt 3: 2000ms delay
- Throws error after 3rd failure

### withTimeout

```typescript
export async function withTimeout<T>(
  promise: Promise<T>,
  timeoutMs: number,
  timeoutError?: Error
): Promise<T>
```

**Source**: Lines 619-640

Races promise with timeout.

**Example**:
```typescript
try {
  const result = await withTimeout(
    fetchSlowData(),
    5000,
    new Error('Request took too long')
  );
} catch (error) {
  console.error('Timeout exceeded');
}
```

---

## Usage Examples

### Animation Example

```typescript
import { animate, spring } from '$lib/utils/ui';

// Fade in element
animate(0, 1, 300, (value) => {
  element.style.opacity = value;
});

// Spring animation for smooth motion
spring(0, 200, 0.2, 0.7, (value) => {
  element.style.left = `${value}px`;
});
```

### Color Manipulation

```typescript
import { parseColor, lighten, getContrastRatio } from '$lib/utils/ui';

const bgColor = '#1a1a1a';
const textColor = '#ffffff';

// Check contrast
const ratio = getContrastRatio(bgColor, textColor);
if (ratio < 4.5) {
  console.warn('Insufficient contrast');
}

// Generate lighter shade
const hoverColor = lighten(bgColor, 0.1);
```

### Format Display Data

```typescript
import { formatFileSize, formatRelativeTime, truncatePath } from '$lib/utils/ui';

// File list display
const file = {
  size: 1048576,
  modified: Date.now() - 3600000,
  path: '/very/long/path/to/my/file.txt'
};

console.log(formatFileSize(file.size));        // "1 MB"
console.log(formatRelativeTime(file.modified)); // "1 hour ago"
console.log(truncatePath(file.path, 30));      // "/very/.../file.txt"
```

### Keyboard Shortcuts

```typescript
import { formatShortcut, getModifierKey } from '$lib/utils/ui';

// Display shortcut hints
const saveShortcut = `${getModifierKey()}+S`;  // "⌘+S" or "Ctrl+S"
const formattedShortcut = formatShortcut('Ctrl+Shift+F'); // Platform-aware
```

### Async Operations

```typescript
import { retry, withTimeout, sleep } from '$lib/utils/ui';

// Retry with exponential backoff
const data = await retry(async () => {
  const response = await fetch('/api/data');
  if (!response.ok) throw new Error('Failed');
  return response.json();
});

// Add timeout to prevent hanging
const result = await withTimeout(
  fetchLargeFile(),
  10000
);
```

---

## Related Documentation

### Components Using These Utilities

- **[StatusBar.svelte](./StatusBar.svelte.md)** - Uses `formatShortcut`
- **[Editor.svelte](./2_Editor.svelte.md)** - Uses clipboard, DOM utilities
- **[Chrome.svelte](./Chrome.svelte.md)** - Uses platform detection
- **[App.svelte](./0_App.svelte.md)** - Uses animation utilities

### Related Files

- **[keybindings.ts](./7_keybindings.ts.md)** - Uses `formatShortcut`, `getModifierKey`
- **[editor.ts](./12_editor.ts.md)** - Uses async utilities
- **[theme.ts](./6_theme.ts.md)** - Could use color utilities

### Project Documentation

- **[STATUS.md](../../STATUS.md)** - Development progress
- **[Technical Details](../3_technical-details.md)** - UI system architecture

---

## Implementation Notes

### Performance Considerations

- **Animations**: Use RAF for smooth 60fps performance
- **Color Parsing**: Results could be cached for frequently-used colors
- **DOM Queries**: getBoundingClientRect causes layout reflow
- **Clipboard**: Requires user gesture for security

### Browser Compatibility

- **Clipboard API**: Requires HTTPS (except localhost)
- **requestAnimationFrame**: Supported in all modern browsers
- **navigator.platform**: Deprecated but still widely supported

### Platform Detection Alternatives

Current implementation uses `navigator.platform` which is deprecated. Future version should use:
```typescript
const platform = navigator.userAgentData?.platform || navigator.platform;
```

### Color Utilities Accuracy

Luminance calculation follows WCAG 2.0 guidelines for accessibility compliance. Contrast ratio ≥ 4.5:1 meets AA standard, ≥ 7:1 meets AAA.

---

**Documentation Version**: 2.0.0
**Module Version**: 0.1.0
**Accuracy**: Verified against source code 2025-10-28
