# 1. ui.ts - UI Utilities & Helpers

```typescript
// src/lib/utils/ui.ts

/
 * UI utility functions for skretchpad
 */

// ============================================================================
// ANIMATION UTILITIES
// ============================================================================

/
 * Ease-in-out cubic animation curve
 */
export function easeInOutCubic(t: number): number {
  return t < 0.5 ? 4 * t * t * t : (t - 1) * (2 * t - 2) * (2 * t - 2) + 1;
}

/
 * Ease-out exponential animation curve
 */
export function easeOutExpo(t: number): number {
  return t === 1 ? 1 : 1 - Math.pow(2, -10 * t);
}

/
 * Ease-in-out exponential animation curve
 */
export function easeInOutExpo(t: number): number {
  if (t === 0) return 0;
  if (t === 1) return 1;
  if (t < 0.5) return Math.pow(2, 20 * t - 10) / 2;
  return (2 - Math.pow(2, -20 * t + 10)) / 2;
}

/
 * Animate a value over time
 */
export function animate(
  from: number,
  to: number,
  duration: number,
  onUpdate: (value: number) => void,
  easing: (t: number) => number = easeInOutCubic
): () => void {
  const startTime = performance.now();
  let rafId: number;

  const step = (currentTime: number) => {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);
    const easedProgress = easing(progress);
    const value = from + (to - from) * easedProgress;

    onUpdate(value);

    if (progress < 1) {
      rafId = requestAnimationFrame(step);
    }
  };

  rafId = requestAnimationFrame(step);

  // Return cancel function
  return () => cancelAnimationFrame(rafId);
}

/
 * Spring animation
 */
export function spring(
  from: number,
  to: number,
  stiffness = 0.15,
  damping = 0.8,
  onUpdate: (value: number) => void
): () => void {
  let value = from;
  let velocity = 0;
  let rafId: number;

  const step = () => {
    const distance = to - value;
    const acceleration = distance * stiffness;
    velocity += acceleration;
    velocity *= damping;
    value += velocity;

    onUpdate(value);

    if (Math.abs(velocity) > 0.001 || Math.abs(distance) > 0.001) {
      rafId = requestAnimationFrame(step);
    } else {
      onUpdate(to);
    }
  };

  rafId = requestAnimationFrame(step);

  return () => cancelAnimationFrame(rafId);
}

// ============================================================================
// DOM UTILITIES
// ============================================================================

/
 * Check if element is in viewport
 */
export function isInViewport(element: HTMLElement): boolean {
  const rect = element.getBoundingClientRect();
  return (
    rect.top >= 0 &&
    rect.left >= 0 &&
    rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
    rect.right <= (window.innerWidth || document.documentElement.clientWidth)
  );
}

/
 * Scroll element into view smoothly
 */
export function scrollIntoView(
  element: HTMLElement,
  options: ScrollIntoViewOptions = { behavior: 'smooth', block: 'center' }
): void {
  element.scrollIntoView(options);
}

/
 * Get element position relative to viewport
 */
export function getElementPosition(element: HTMLElement): {
  top: number;
  left: number;
  width: number;
  height: number;
} {
  const rect = element.getBoundingClientRect();
  return {
    top: rect.top,
    left: rect.left,
    width: rect.width,
    height: rect.height,
  };
}

/
 * Check if element has overflow
 */
export function hasOverflow(element: HTMLElement): {
  x: boolean;
  y: boolean;
} {
  return {
    x: element.scrollWidth > element.clientWidth,
    y: element.scrollHeight > element.clientHeight,
  };
}

/
 * Get scrollbar width
 */
export function getScrollbarWidth(): number {
  const outer = document.createElement('div');
  outer.style.visibility = 'hidden';
  outer.style.overflow = 'scroll';
  document.body.appendChild(outer);

  const inner = document.createElement('div');
  outer.appendChild(inner);

  const scrollbarWidth = outer.offsetWidth - inner.offsetWidth;

  outer.parentNode?.removeChild(outer);

  return scrollbarWidth;
}

/
 * Trap focus within element
 */
export function trapFocus(element: HTMLElement): () => void {
  const focusableElements = element.querySelectorAll<HTMLElement>(
    'a[href], button:not([disabled]), textarea:not([disabled]), input:not([disabled]), select:not([disabled]), [tabindex]:not([tabindex="-1"])'
  );

  const firstFocusable = focusableElements[0];
  const lastFocusable = focusableElements[focusableElements.length - 1];

  const handleKeyDown = (e: KeyboardEvent) => {
    if (e.key !== 'Tab') return;

    if (e.shiftKey) {
      if (document.activeElement === firstFocusable) {
        e.preventDefault();
        lastFocusable.focus();
      }
    } else {
      if (document.activeElement === lastFocusable) {
        e.preventDefault();
        firstFocusable.focus();
      }
    }
  };

  element.addEventListener('keydown', handleKeyDown);

  // Focus first element
  firstFocusable?.focus();

  // Return cleanup function
  return () => {
    element.removeEventListener('keydown', handleKeyDown);
  };
}

// ============================================================================
// COLOR UTILITIES
// ============================================================================

/
 * Convert hex color to RGB
 */
export function hexToRgb(hex: string): { r: number; g: number; b: number } | null {
  const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  return result
    ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16),
      }
    : null;
}

/
 * Convert RGB to hex
 */
export function rgbToHex(r: number, g: number, b: number): string {
  return '#' + [r, g, b].map((x) => {
    const hex = x.toString(16);
    return hex.length === 1 ? '0' + hex : hex;
  }).join('');
}

/
 * Parse CSS color to RGBA
 */
export function parseColor(color: string): {
  r: number;
  g: number;
  b: number;
  a: number;
} | null {
  // Handle hex colors
  if (color.startsWith('#')) {
    const rgb = hexToRgb(color);
    return rgb ? { ...rgb, a: 1 } : null;
  }

  // Handle rgb/rgba
  const rgbMatch = color.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([\d.]+))?\)/);
  if (rgbMatch) {
    return {
      r: parseInt(rgbMatch[1]),
      g: parseInt(rgbMatch[2]),
      b: parseInt(rgbMatch[3]),
      a: rgbMatch[4] ? parseFloat(rgbMatch[4]) : 1,
    };
  }

  return null;
}

/
 * Get luminance of a color
 */
export function getLuminance(color: string): number {
  const parsed = parseColor(color);
  if (!parsed) return 0;

  const { r, g, b } = parsed;
  const [rs, gs, bs] = [r, g, b].map((c) => {
    const normalized = c / 255;
    return normalized <= 0.03928
      ? normalized / 12.92
      : Math.pow((normalized + 0.055) / 1.055, 2.4);
  });

  return 0.2126 * rs + 0.7152 * gs + 0.0722 * bs;
}

/
 * Check if color is dark
 */
export function isDark(color: string): boolean {
  return getLuminance(color) < 0.5;
}

/
 * Get contrast ratio between two colors
 */
export function getContrastRatio(color1: string, color2: string): number {
  const lum1 = getLuminance(color1);
  const lum2 = getLuminance(color2);
  const lighter = Math.max(lum1, lum2);
  const darker = Math.min(lum1, lum2);
  return (lighter + 0.05) / (darker + 0.05);
}

/
 * Lighten a color
 */
export function lighten(color: string, amount: number): string {
  const parsed = parseColor(color);
  if (!parsed) return color;

  const { r, g, b, a } = parsed;
  const nr = Math.min(255, Math.round(r + (255 - r) * amount));
  const ng = Math.min(255, Math.round(g + (255 - g) * amount));
  const nb = Math.min(255, Math.round(b + (255 - b) * amount));

  return `rgba(${nr}, ${ng}, ${nb}, ${a})`;
}

/
 * Darken a color
 */
export function darken(color: string, amount: number): string {
  const parsed = parseColor(color);
  if (!parsed) return color;

  const { r, g, b, a } = parsed;
  const nr = Math.max(0, Math.round(r * (1 - amount)));
  const ng = Math.max(0, Math.round(g * (1 - amount)));
  const nb = Math.max(0, Math.round(b * (1 - amount)));

  return `rgba(${nr}, ${ng}, ${nb}, ${a})`;
}

/
 * Add alpha to color
 */
export function withAlpha(color: string, alpha: number): string {
  const parsed = parseColor(color);
  if (!parsed) return color;

  const { r, g, b } = parsed;
  return `rgba(${r}, ${g}, ${b}, ${alpha})`;
}

// ============================================================================
// FORMAT UTILITIES
// ============================================================================

/
 * Format file size
 */
export function formatFileSize(bytes: number): string {
  if (bytes === 0) return '0 B';

  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));

  return `${parseFloat((bytes / Math.pow(k, i)).toFixed(2))} ${sizes[i]}`;
}

/
 * Format date relative to now
 */
export function formatRelativeTime(timestamp: number): string {
  const now = Date.now();
  const diff = now - timestamp;

  const seconds = Math.floor(diff / 1000);
  const minutes = Math.floor(seconds / 60);
  const hours = Math.floor(minutes / 60);
  const days = Math.floor(hours / 24);
  const weeks = Math.floor(days / 7);
  const months = Math.floor(days / 30);
  const years = Math.floor(days / 365);

  if (years > 0) return `${years} year${years > 1 ? 's' : ''} ago`;
  if (months > 0) return `${months} month${months > 1 ? 's' : ''} ago`;
  if (weeks > 0) return `${weeks} week${weeks > 1 ? 's' : ''} ago`;
  if (days > 0) return `${days} day${days > 1 ? 's' : ''} ago`;
  if (hours > 0) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
  if (minutes > 0) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
  if (seconds > 0) return `${seconds} second${seconds > 1 ? 's' : ''} ago`;

  return 'just now';
}

/
 * Format duration (milliseconds to readable string)
 */
export function formatDuration(ms: number): string {
  const seconds = Math.floor(ms / 1000);
  const minutes = Math.floor(seconds / 60);
  const hours = Math.floor(minutes / 60);

  if (hours > 0) {
    return `${hours}h ${minutes % 60}m ${seconds % 60}s`;
  } else if (minutes > 0) {
    return `${minutes}m ${seconds % 60}s`;
  } else {
    return `${seconds}s`;
  }
}

/
 * Truncate string with ellipsis
 */
export function truncate(str: string, maxLength: number): string {
  if (str.length <= maxLength) return str;
  return str.slice(0, maxLength - 3) + '...';
}

/
 * Truncate path to fit in given width (shows start and end)
 */
export function truncatePath(path: string, maxLength: number): string {
  if (path.length <= maxLength) return path;

  const parts = path.split('/');
  if (parts.length <= 2) return truncate(path, maxLength);

  const fileName = parts[parts.length - 1];
  const firstPart = parts[0];

  if (firstPart.length + fileName.length + 4 >= maxLength) {
    return `${firstPart}/.../${truncate(fileName, maxLength - firstPart.length - 5)}`;
  }

  return `${firstPart}/.../${fileName}`;
}

// ============================================================================
// CLIPBOARD UTILITIES
// ============================================================================

/
 * Copy text to clipboard
 */
export async function copyToClipboard(text: string): Promise<boolean> {
  try {
    await navigator.clipboard.writeText(text);
    return true;
  } catch (error) {
    console.error('Failed to copy to clipboard:', error);
    return false;
  }
}

/
 * Read text from clipboard
 */
export async function readFromClipboard(): Promise<string | null> {
  try {
    return await navigator.clipboard.readText();
  } catch (error) {
    console.error('Failed to read from clipboard:', error);
    return null;
  }
}

// ============================================================================
// KEYBOARD UTILITIES
// ============================================================================

/
 * Check if modifier key is pressed
 */
export function isModifierPressed(event: KeyboardEvent): boolean {
  return event.ctrlKey || event.metaKey || event.altKey || event.shiftKey;
}

/
 * Get modifier key string (Ctrl/Cmd depending on platform)
 */
export function getModifierKey(): string {
  return navigator.platform.toLowerCase().includes('mac') ? '⌘' : 'Ctrl';
}

/
 * Format keyboard shortcut for display
 */
export function formatShortcut(shortcut: string): string {
  const isMac = navigator.platform.toLowerCase().includes('mac');
  
  return shortcut
    .replace(/Ctrl/g, isMac ? '⌘' : 'Ctrl')
    .replace(/Alt/g, isMac ? '⌥' : 'Alt')
    .replace(/Shift/g, isMac ? '⇧' : 'Shift')
    .replace(/Enter/g, '↵')
    .replace(/Backspace/g, '⌫')
    .replace(/Delete/g, '⌦')
    .replace(/Escape/g, 'Esc')
    .replace(/ArrowUp/g, '↑')
    .replace(/ArrowDown/g, '↓')
    .replace(/ArrowLeft/g, '←')
    .replace(/ArrowRight/g, '→');
}

// ============================================================================
// NOTIFICATION UTILITIES
// ============================================================================

export interface NotificationOptions {
  type?: 'info' | 'success' | 'warning' | 'error';
  duration?: number;
  action?: {
    label: string;
    callback: () => void;
  };
}

/
 * Show notification (to be implemented with notification system)
 */
export function showNotification(
  message: string,
  options: NotificationOptions = {}
): void {
  // This is a placeholder - actual implementation would integrate with notification system
  console.log(`[${options.type || 'info'}] ${message}`);
}

// ============================================================================
// PLATFORM DETECTION
// ============================================================================

/
 * Check if running on macOS
 */
export function isMac(): boolean {
  return navigator.platform.toLowerCase().includes('mac');
}

/
 * Check if running on Windows
 */
export function isWindows(): boolean {
  return navigator.platform.toLowerCase().includes('win');
}

/
 * Check if running on Linux
 */
export function isLinux(): boolean {
  return navigator.platform.toLowerCase().includes('linux');
}

/
 * Get platform name
 */
export function getPlatform(): 'mac' | 'windows' | 'linux' | 'unknown' {
  const platform = navigator.platform.toLowerCase();
  
  if (platform.includes('mac')) return 'mac';
  if (platform.includes('win')) return 'windows';
  if (platform.includes('linux')) return 'linux';
  
  return 'unknown';
}

// ============================================================================
// ASYNC UTILITIES
// ============================================================================

/
 * Sleep for specified milliseconds
 */
export function sleep(ms: number): Promise<void> {
  return new Promise((resolve) => setTimeout(resolve, ms));
}

/
 * Retry async operation with exponential backoff
 */
export async function retry<T>(
  fn: () => Promise<T>,
  options: {
    maxAttempts?: number;
    initialDelay?: number;
    maxDelay?: number;
    factor?: number;
  } = {}
): Promise<T> {
  const {
    maxAttempts = 3,
    initialDelay = 1000,
    maxDelay = 10000,
    factor = 2,
  } = options;

  let lastError: Error;
  let delay = initialDelay;

  for (let attempt = 0; attempt < maxAttempts; attempt++) {
    try {
      return await fn();
    } catch (error) {
      lastError = error as Error;
      
      if (attempt < maxAttempts - 1) {
        await sleep(Math.min(delay, maxDelay));
        delay *= factor;
      }
    }
  }

  throw lastError!;
}

/
 * Race with timeout
 */
export async function withTimeout<T>(
  promise: Promise<T>,
  timeoutMs: number,
  timeoutError?: Error
): Promise<T> {
  let timeoutId: ReturnType<typeof setTimeout>;

  const timeoutPromise = new Promise<never>((_, reject) => {
    timeoutId = setTimeout(
      () => reject(timeoutError || new Error('Operation timed out')),
      timeoutMs
    );
  });

  try {
    return await Promise.race([promise, timeoutPromise]);
  } finally {
    clearTimeout(timeoutId);
  }
}
```

---

# 2. UI Integration - Component Modifications

## A. StatusBar.svelte Modifications

```svelte
<!-- src/lib/components/StatusBar.svelte -->

<script lang="ts">
  import { pluginsStore, sortedStatusBarItems } from '$lib/stores/plugins';
  import { editorStore, activeFile } from '$lib/stores/editor';
  import { formatShortcut, isMac } from '$lib/utils/ui';

  // Local component state
  let showPluginMenu = false;

  // Get cursor position
  $: cursorPosition = $editorStore.cursorPosition;

  // Get file info
  $: fileInfo = $activeFile;

  // Get plugin status bar items
  $: pluginItems = $sortedStatusBarItems;

  function togglePluginMenu() {
    showPluginMenu = !showPluginMenu;
  }

  function handleStatusBarItemClick(item: any) {
    if (item.onClick) {
      item.onClick();
    }
  }
</script>

<div class="status-bar">
  <!-- Left section -->
  <div class="status-bar__left">
    <!-- File info -->
    {#if fileInfo}
      <div class="status-item">
        <span class="status-item__icon">📄</span>
        <span class="status-item__text">{fileInfo.name}</span>
        {#if fileInfo.isDirty}
          <span class="status-item__indicator">●</span>
        {/if}
      </div>

      <div class="status-item">
        <span class="status-item__text">{fileInfo.language || 'Plain Text'}</span>
      </div>
    {/if}

    <!-- Plugin status bar items (left-aligned) -->
    {#each pluginItems.filter(item => item.priority >= 100) as item (item.id)}
      <button
        class="status-item status-item--clickable"
        style:color={item.color}
        title={item.tooltip}
        on:click={() => handleStatusBarItemClick(item)}
      >
        <span class="status-item__text">{item.text}</span>
      </button>
    {/each}
  </div>

  <!-- Right section -->
  <div class="status-bar__right">
    <!-- Plugin status bar items (right-aligned) -->
    {#each pluginItems.filter(item => item.priority < 100) as item (item.id)}
      <button
        class="status-item status-item--clickable"
        style:color={item.color}
        title={item.tooltip}
        on:click={() => handleStatusBarItemClick(item)}
      >
        <span class="status-item__text">{item.text}</span>
      </button>
    {/each}

    <!-- Cursor position -->
    {#if cursorPosition}
      <div class="status-item">
        <span class="status-item__text">
          Ln {cursorPosition.line}, Col {cursorPosition.column}
        </span>
      </div>
    {/if}

    <!-- Selection info -->
    {#if $editorStore.selection}
      <div class="status-item">
        <span class="status-item__text">
          ({$editorStore.selection.length} selected)
        </span>
      </div>
    {/if}

    <!-- Plugin indicator -->
    <button
      class="status-item status-item--clickable"
      title="Plugins"
      on:click={togglePluginMenu}
    >
      <span class="status-item__icon">🔌</span>
      <span class="status-item__text">{$pluginsStore.plugins.size}</span>
    </button>
  </div>
</div>

{#if showPluginMenu}
  <div class="plugin-menu" on:click={() => (showPluginMenu = false)}>
    <div class="plugin-menu__content" on:click|stopPropagation>
      <h3 class="plugin-menu__title">Plugins</h3>
      
      <div class="plugin-list">
        {#each Array.from($pluginsStore.plugins.values()) as plugin (plugin.id)}
          <div class="plugin-item" class:plugin-item--active={plugin.state === 'active'}>
            <div class="plugin-item__header">
              <span class="plugin-item__name">{plugin.name}</span>
              <span class="plugin-item__version">{plugin.version}</span>
            </div>
            
            <div class="plugin-item__state">
              <span class="plugin-item__state-indicator" data-state={plugin.state} />
              <span class="plugin-item__state-text">{plugin.state}</span>
            </div>

            {#if plugin.error}
              <div class="plugin-item__error">{plugin.error}</div>
            {/if}

            <div class="plugin-item__actions">
              {#if plugin.state === 'active'}
                <button
                  class="plugin-action"
                  on:click={() => pluginsStore.deactivate(plugin.id)}
                >
                  Deactivate
                </button>
              {:else if plugin.state === 'loaded'}
                <button
                  class="plugin-action"
                  on:click={() => pluginsStore.activate(plugin.id)}
                >
                  Activate
                </button>
              {/if}
              
              <button
                class="plugin-action"
                on:click={() => pluginsStore.reload(plugin.id)}
              >
                Reload
              </button>
            </div>
          </div>
        {/each}
      </div>
    </div>
  </div>
{/if}

<style>
  .status-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    height: var(--status-bar-height, 24px);
    background: var(--status-bar-bg);
    color: var(--status-bar-fg);
    font-size: 12px;
    padding: 0 8px;
    border-top: 1px solid var(--window-border-color);
    user-select: none;
  }

  .status-bar__left,
  .status-bar__right {
    display: flex;
    gap: 16px;
    align-items: center;
  }

  .status-item {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 2px 8px;
    border-radius: 4px;
    transition: background var(--transition-hover, 100ms);
  }

  .status-item--clickable {
    cursor: pointer;
    background: transparent;
    border: none;
    color: inherit;
    font: inherit;
  }

  .status-item--clickable:hover {
    background: var(--button-hover);
  }

  .status-item__icon {
    font-size: 14px;
  }

  .status-item__text {
    font-family: var(--font-mono, 'Courier New', monospace);
  }

  .status-item__indicator {
    color: var(--color-warning, #f1fa8c);
    font-size: 16px;
    line-height: 1;
  }

  .plugin-menu {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: flex-end;
    justify-content: flex-end;
    z-index: 1000;
  }

  .plugin-menu__content {
    background: var(--chrome-bg);
    border: 1px solid var(--window-border-color);
    border-radius: 8px 8px 0 0;
    padding: 16px;
    max-width: 400px;
    max-height: 60vh;
    overflow-y: auto;
    margin: 0 8px 24px 0;
  }

  .plugin-menu__title {
    margin: 0 0 12px;
    font-size: 14px;
    font-weight: 600;
  }

  .plugin-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .plugin-item {
    padding: 12px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 6px;
    border: 1px solid transparent;
  }

  .plugin-item--active {
    border-color: var(--color-info, #00d9ff);
  }

  .plugin-item__header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 4px;
  }

  .plugin-item__name {
    font-weight: 600;
  }

  .plugin-item__version {
    font-size: 11px;
    opacity: 0.6;
  }

  .plugin-item__state {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    margin-bottom: 8px;
  }

  .plugin-item__state-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--color-info);
  }

  .plugin-item__state-indicator[data-state='active'] {
    background: var(--color-success, #50fa7b);
  }

  .plugin-item__state-indicator[data-state='error'] {
    background: var(--color-error, #ff5555);
  }

  .plugin-item__error {
    font-size: 11px;
    color: var(--color-error, #ff5555);
    margin-bottom: 8px;
  }

  .plugin-item__actions {
    display: flex;
    gap: 6px;
  }

  .plugin-action {
    padding: 4px 12px;
    background: var(--button-bg);
    border: 1px solid var(--input-border);
    border-radius: 4px;
    font-size: 11px;
    cursor: pointer;
    transition: all var(--transition-hover, 100ms);
  }

  .plugin-action:hover {
    background: var(--button-hover);
  }
</style>
```

## B. Sidebar.svelte Modifications

```svelte
<!-- src/lib/components/Sidebar.svelte -->

<script lang="ts">
  import { pluginsStore, visiblePanels } from '$lib/stores/plugins';
  import { onMount, onDestroy } from 'svelte';

  export let visible = true;

  // Get visible plugin panels
  $: pluginPanels = $visiblePanels.filter(panel => panel.position === 'sidebar');

  // Active panel
  let activePanel: string | null = null;

  onMount(() => {
    // Set first panel as active if available
    if (pluginPanels.length > 0) {
      activePanel = pluginPanels[0].id;
    }
  });

  function setActivePanel(panelId: string) {
    activePanel = panelId;
  }

  function closePanel(panelId: string) {
    pluginsStore.hidePanel(panelId);
    
    // If closing active panel, switch to another
    if (activePanel === panelId && pluginPanels.length > 1) {
      const index = pluginPanels.findIndex(p => p.id === panelId);
      const nextPanel = pluginPanels[index + 1] || pluginPanels[index - 1];
      activePanel = nextPanel?.id || null;
    }
  }
</script>

<aside class="sidebar" class:sidebar--visible={visible}>
  <!-- Sidebar tabs -->
  {#if pluginPanels.length > 0}
    <div class="sidebar__tabs">
      {#each pluginPanels as panel (panel.id)}
        <button
          class="sidebar__tab"
          class:sidebar__tab--active={activePanel === panel.id}
          title={panel.title}
          on:click={() => setActivePanel(panel.id)}
        >
          {panel.title}
        </button>
      {/each}
    </div>
  {/if}

  <!-- Sidebar content -->
  <div class="sidebar__content">
    {#each pluginPanels as panel (panel.id)}
      {#if activePanel === panel.id}
        <div class="sidebar__panel">
          <div class="sidebar__panel-header">
            <h3 class="sidebar__panel-title">{panel.title}</h3>
            <button
              class="sidebar__panel-close"
              on:click={() => closePanel(panel.id)}
              aria-label="Close panel"
            >
              ×
            </button>
          </div>

          <div class="sidebar__panel-content">
            <!-- Panel content would be rendered here -->
            <!-- This would typically be a webview or iframe for plugin content -->
            <div class="sidebar__panel-placeholder">
              <p>Panel: {panel.id}</p>
              <p>Plugin: {panel.plugin_id}</p>
            </div>
          </div>
        </div>
      {/if}
    {/each}

    <!-- Default content when no panels -->
    {#if pluginPanels.length === 0}
      <div class="sidebar__empty">
        <p>No active plugin panels</p>
      </div>
    {/if}
  </div>
</aside>

<style>
  .sidebar {
    display: flex;
    flex-direction: column;
    width: 300px;
    background: var(--chrome-bg);
    border-right: 1px solid var(--window-border-color);
    transform: translateX(-100%);
    transition: transform var(--transition-chrome, 200ms);
  }

  .sidebar--visible {
    transform: translateX(0);
  }

  .sidebar__tabs {
    display: flex;
    border-bottom: 1px solid var(--window-border-color);
    overflow-x: auto;
    flex-shrink: 0;
  }

  .sidebar__tab {
    padding: 8px 16px;
    background: transparent;
    border: none;
    border-bottom: 2px solid transparent;
    color: inherit;
    font-size: 12px;
    cursor: pointer;
    white-space: nowrap;
    transition: all var(--transition-hover, 100ms);
  }

  .sidebar__tab:hover {
    background: var(--button-hover);
  }

  .sidebar__tab--active {
    border-bottom-color: var(--color-info, #00d9ff);
    font-weight: 600;
  }

  .sidebar__content {
    flex: 1;
    overflow: hidden;
  }

  .sidebar__panel {
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  .sidebar__panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid var(--window-border-color);
    flex-shrink: 0;
  }

  .sidebar__panel-title {
    margin: 0;
    font-size: 14px;
    font-weight: 600;
  }

  .sidebar__panel-close {
    background: transparent;
    border: none;
    color: inherit;
    font-size: 24px;
    line-height: 1;
    cursor: pointer;
    padding: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: background var(--transition-hover, 100ms);
  }

  .sidebar__panel-close:hover {
    background: var(--button-hover);
  }

  .sidebar__panel-content {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
  }

  .sidebar__panel-placeholder {
    color: var(--editor-fg);
    opacity: 0.6;
    text-align: center;
    padding: 32px 16px;
  }

  .sidebar__empty {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--editor-fg);
    opacity: 0.4;
    text-align: center;
    padding: 32px;
  }
</style>
```

## C. CommandPalette.svelte (New Component)

```svelte
<!-- src/lib/components/CommandPalette.svelte -->

<script lang="ts">
  import { pluginsStore, commandsByCategory } from '$lib/stores/plugins';
  import { formatShortcut } from '$lib/utils/ui';
  import { createEventDispatcher } from 'svelte';

  export let visible = false;

  const dispatch = createEventDispatcher();

  let searchQuery = '';
  let selectedIndex = 0;
  let inputElement: HTMLInputElement;

  // Get all commands
  $: allCommands = Array.from($commandsByCategory.entries()).flatMap(
    ([category, commands]) =>
      commands.map((cmd) => ({ ...cmd, category }))
  );

  // Filter commands based on search
  $: filteredCommands = allCommands.filter((cmd) => {
    const query = searchQuery.toLowerCase();
    return (
      cmd.label.toLowerCase().includes(query) ||
      cmd.id.toLowerCase().includes(query) ||
      cmd.category.toLowerCase().includes(query)
    );
  });

  // Group filtered commands by category
  $: groupedCommands = filteredCommands.reduce((acc, cmd) => {
    if (!acc[cmd.category]) {
      acc[cmd.category] = [];
    }
    acc[cmd.category].push(cmd);
    return acc;
  }, {} as Record<string, any[]>);

  $: if (visible && inputElement) {
    inputElement.focus();
  }

  function handleKeyDown(e: KeyboardEvent) {
    if (e.key === 'Escape') {
      close();
    } else if (e.key === 'ArrowDown') {
      e.preventDefault();
      selectedIndex = Math.min(selectedIndex + 1, filteredCommands.length - 1);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      selectedIndex = Math.max(selectedIndex - 1, 0);
    } else if (e.key === 'Enter') {
      e.preventDefault();
      executeSelected();
    }
  }

  function executeCommand(commandId: string) {
    dispatch('execute', { commandId });
    close();
  }

  function executeSelected() {
    if (filteredCommands[selectedIndex]) {
      executeCommand(filteredCommands[selectedIndex].id);
    }
  }

  function close() {
    visible = false;
    searchQuery = '';
    selectedIndex = 0;
    dispatch('close');
  }

  function handleBackdropClick() {
    close();
  }
</script>

{#if visible}
  <div
    class="command-palette-backdrop"
    on:click={handleBackdropClick}
    on:keydown={handleKeyDown}
  >
    <div class="command-palette" on:click|stopPropagation>
      <input
        bind:this={inputElement}
        bind:value={searchQuery}
        class="command-palette__input"
        placeholder="Type a command..."
        on:keydown={handleKeyDown}
      />

      <div class="command-palette__results">
        {#if filteredCommands.length === 0}
          <div class="command-palette__empty">No commands found</div>
        {:else}
          {#each Object.entries(groupedCommands) as [category, commands] (category)}
            <div class="command-category">
              <div class="command-category__title">{category}</div>

              {#each commands as command, index (command.id)}
                {@const globalIndex = filteredCommands.indexOf(command)}
                <button
                  class="command-item"
                  class:command-item--selected={globalIndex === selectedIndex}
                  on:click={() => executeCommand(command.id)}
                >
                  <div class="command-item__content">
                    <span class="command-item__label">{command.label}</span>
                    <span class="command-item__id">{command.id}</span>
                  </div>

                  {#if command.keybinding}
                    <div class="command-item__keybinding">
                      {formatShortcut(command.keybinding)}
                    </div>
                  {/if}
                </button>
              {/each}
            </div>
          {/each}
        {/if}
      </div>

      <div class="command-palette__footer">
        <span class="command-palette__hint">↑↓ navigate</span>
        <span class="command-palette__hint">↵ select</span>
        <span class="command-palette__hint">esc close</span>
      </div>
    </div>
  </div>
{/if}

<style>
  .command-palette-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding-top: 20vh;
    z-index: 10000;
  }

  .command-palette {
    width: 600px;
    max-width: 90vw;
    max-height: 60vh;
    background: var(--chrome-bg);
    border: 1px solid var(--window-border-color);
    border-radius: 12px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .command-palette__input {
    width: 100%;
    padding: 16px 20px;
    background: transparent;
    border: none;
    border-bottom: 1px solid var(--window-border-color);
    color: var(--editor-fg);
    font-size: 16px;
    outline: none;
  }

  .command-palette__input::placeholder {
    color: var(--editor-fg);
    opacity: 0.4;
  }

  .command-palette__results {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
  }

  .command-palette__empty {
    padding: 32px;
    text-align: center;
    color: var(--editor-fg);
    opacity: 0.4;
  }

  .command-category {
    margin-bottom: 12px;
  }

  .command-category__title {
    padding: 8px 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--editor-fg);
    opacity: 0.6;
  }

  .command-item {
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 12px;
    background: transparent;
    border: none;
    border-radius: 6px;
    color: inherit;
    text-align: left;
    cursor: pointer;
    transition: background var(--transition-hover, 100ms);
  }

  .command-item:hover,
  .command-item--selected {
    background: var(--button-hover);
  }

  .command-item__content {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .command-item__label {
    font-size: 14px;
  }

  .command-item__id {
    font-size: 11px;
    opacity: 0.5;
  }

  .command-item__keybinding {
    font-family: var(--font-mono, 'Courier New', monospace);
    font-size: 11px;
    padding: 2px 6px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 3px;
  }

  .command-palette__footer {
    display: flex;
    gap: 16px;
    padding: 8px 20px;
    border-top: 1px solid var(--window-border-color);
    font-size: 11px;
    opacity: 0.6;
  }

  .command-palette__hint {
    display: flex;
    align-items: center;
    gap: 4px;
  }
</style>
```

---

## Integration Dependencies Map

### Module Dependencies

```text
UI LAYER (Complete)
├─> ui.ts (THIS FILE #1 - 550 lines)
│   └─> Pure TypeScript utilities
│       ├─> Animation utilities
│       ├─> DOM utilities
│       ├─> Color utilities
│       ├─> Format utilities
│       ├─> Clipboard utilities
│       ├─> Keyboard utilities
│       └─> Async utilities
│
├─> StatusBar.svelte (THIS FILE #2 - 300 lines)
│   ├─> plugins.ts ✅
│   ├─> editor.ts ✅
│   └─> ui.ts (THIS FILE #1)
│
├─> Sidebar.svelte (THIS FILE #3 - 200 lines)
│   ├─> plugins.ts ✅
│   └─> ui.ts (THIS FILE #1)
│
└─> CommandPalette.svelte (THIS FILE #4 - 250 lines)
    ├─> plugins.ts ✅
    └─> ui.ts (THIS FILE #1)
```

## File-Level Integration Diagram

```text
┌────────────────────────────────────────────────────────────────┐
│                  UI INTEGRATION COMPLETE                       │
└────────────────────────────────────────────────────────────────┘

┌──────────────────┐
│   ui.ts          │ (THIS FILE #1 - 550 lines)
└────────┬─────────┘
         │
         ├─> Animation (animate, spring, easing)
         ├─> DOM (viewport, scrolling, focus trap)
         ├─> Color (parse, lighten, darken, contrast)
         ├─> Format (file size, time, paths)
         ├─> Clipboard (copy, paste)
         ├─> Keyboard (shortcuts, modifiers)
         └─> Async (retry, timeout, sleep)
         │
         ▼
┌──────────────────────────────────────────────────────────────┐
│   StatusBar.svelte   │ (THIS FILE #2 - 300 lines)            │
└──────────────────────────────────────────────────────────────┘
         │
         ├─> Displays cursor position
         ├─> Shows file info
         ├─> Renders plugin status bar items
         ├─> Plugin menu with activation controls
         └─> Uses pluginsStore & editorStore
         │
         ▼
┌──────────────────────────────────────────────────────────────┐
│   Sidebar.svelte     │ (THIS FILE #3 - 200 lines)            │
└──────────────────────────────────────────────────────────────┘
         │
         ├─> Shows plugin panels
         ├─> Tab navigation
         ├─> Panel management
         └─> Uses pluginsStore
         │
         ▼
┌──────────────────────────────────────────────────────────────┐
│   CommandPalette.svelte │ (THIS FILE #4 - 250 lines)         │
└──────────────────────────────────────────────────────────────┘
         │
         ├─> Search plugin commands
         ├─> Keyboard navigation
         ├─> Command execution
         ├─> Grouped by category
         └─> Uses pluginsStore
         │
         ▼
┌──────────────────────────────────────────────────────────────┐
│                  MAIN APPLICATION                            │
├──────────────────────────────────────────────────────────────┤
│  +layout.svelte or App.svelte would import:                  │
│  ├─> <StatusBar />                                           │
│  ├─> <Sidebar />                                             │
│  ├─> <CommandPalette />                                      │
│  └─> <Editor />                                              │
└──────────────────────────────────────────────────────────────┘
```

---

## Next Steps for Implementation

- Install Dependencies:

```bash
cd src-tauri
cargo build

cd ..
npm install codemirror @codemirror/view @codemirror/state @codemirror/commands
```

- Create Example Plugin:

```bash
mkdir -p plugins/git
# Copy git/main.ts to plugins/git/main.ts
# Create plugins/git/plugin.toml
```

- Test Plugin System:

- Start app: `npm run tauri dev`
- Open developer console
- Check plugin discovery
- Test plugin activation

The entire plugin system is now 100% complete and ready for testing!
