╭────────────────────────────────────────────────────────────────────────────────────╮
│ Plan to implement                                                                  │
│                                                                                    │
│ v0.0.11 Plan: Wire Up Plugin System Scaffolding                                    │
│                                                                                    │
│ Context                                                                            │
│                                                                                    │
│ The plugin system has 24 dead-code warnings across 7 Rust files. These are         │
│ well-architected security and lifecycle APIs that were scaffolded but never        │
│ integrated into the runtime. This plan wires every unused API into actual          │
│ execution paths so the warnings disappear through real usage — not suppression.    │
│                                                                                    │
│ Warning sources: capabilities.rs (6), loader.rs (4), manager.rs (4), sandbox.rs    │
│ (7), trust.rs (5), worker.rs (5), api.rs (1)                                       │
│                                                                                    │
│ ---                                                                                │
│ Phase 1: Trust System Integration                                                  │
│                                                                                    │
│ Goal: Wire TrustLevel methods, TrustVerifier, and PluginSignature into the plugin  │
│ activation path.                                                                   │
│                                                                                    │
│ manager.rs — activate() trust checks                                               │
│                                                                                    │
│ Before creating the sandbox in activate():                                         │
│ - Call self.loader.is_first_party(plugin_id) to log trust status                   │
│ - Call plugin_info.manifest.trust.is_trusted() to decide strictness                │
│ - Call plugin_info.manifest.trust.auto_grant_permissions() — if true, skip         │
│ permission prompt on frontend                                                      │
│                                                                                    │
│ main.rs — TrustVerifier as managed state                                           │
│                                                                                    │
│ - Create TrustVerifier::new() in setup, manage as Arc<RwLock<TrustVerifier>>       │
│ - Before manager.activate() in the activate_plugin command: if                     │
│ manifest.trust.requires_signature() AND manifest has a signature, call             │
│ verifier.verify_signature(&sig) — reject on failure                                │
│ - First-party plugins: requires_signature() returns true but TrustVerifier has     │
│ "skretchpad-official" pre-loaded, so stub signatures pass                          │
│ - Add add_trusted_key and remove_trusted_key Tauri commands                        │
│                                                                                    │
│ loader.rs — Signature validation                                                   │
│                                                                                    │
│ When parsing manifest in load(), if signature section exists: construct            │
│ PluginSignature::new(key, sig), call is_valid() as sanity check. If invalid,       │
│ return LoaderError::InvalidManifest.                                               │
│                                                                                    │
│ manager.rs — Enrich PluginStatus                                                   │
│                                                                                    │
│ Add fields to PluginStatus:                                                        │
│ pub trust: TrustLevel,                                                             │
│ pub loaded_at: Option<u64>,  // epoch millis from PluginInfo.loaded_at             │
│                                                                                    │
│ Wire in get_status() from PluginInfo.loaded_at and manifest.trust.                 │
│                                                                                    │
│ Warnings resolved: 12                                                              │
│                                                                                    │
│ - trust.rs: auto_grant_permissions, requires_signature, is_trusted (3)             │
│ - trust.rs: PluginSignature::new, is_valid (2)                                     │
│ - trust.rs: TrustVerifier + all 4 methods (5)                                      │
│ - loader.rs: loaded_at field, is_first_party (2)                                   │
│                                                                                    │
│ ---                                                                                │
│ Phase 2: Event System & Plugin Lifecycle                                           │
│                                                                                    │
│ Goal: Wire event cleanup, lifecycle events, loader error variants, unload, and     │
│ file watcher count.                                                                │
│                                                                                    │
│ manager.rs — Event cleanup on deactivate                                           │
│                                                                                    │
│ In deactivate(), before removing sandbox:                                          │
│ let events: Vec<String> = self.event_listeners.keys().cloned().collect();          │
│ for event_name in events {                                                         │
│     self.unregister_event_listener(plugin_id, &event_name);                        │
│ }                                                                                  │
│                                                                                    │
│ manager.rs — Emit lifecycle events                                                 │
│                                                                                    │
│ After successful activate: self.emit_event("plugin:activated", json!({"plugin_id": │
│  plugin_id})).await                                                                │
│ After deactivate: self.emit_event("plugin:deactivated", json!({"plugin_id":        │
│ plugin_id})).await                                                                 │
│                                                                                    │
│ manager.rs — Use get_event_listeners + sandbox_registry                            │
│                                                                                    │
│ Add get_plugin_event_listeners Tauri command that calls                            │
│ manager.get_event_listeners(event_name).                                           │
│ In get_all_statuses(), use self.sandbox_registry() to cross-check active           │
│ sandboxes.                                                                         │
│                                                                                    │
│ manager.rs — Add unload()                                                          │
│                                                                                    │
│ New method that calls self.loader.unload(plugin_id) + cleans up state. Exposed as  │
│ unload_plugin Tauri command.                                                       │
│                                                                                    │
│ manager.rs — Use verify_dependencies from loader                                   │
│                                                                                    │
│ In check_dependencies(), call self.loader.verify_dependencies(plugin_id) first     │
│ (checks deps are loaded), then keep existing active-state checks.                  │
│                                                                                    │
│ loader.rs — Use error variants                                                     │
│                                                                                    │
│ Replace generic format!() errors in load()/load_manifest():                        │
│ - ManifestNotFound(plugin_id) when manifest file missing                           │
│ - InvalidManifest(msg) when TOML parse fails                                       │
│ - AlreadyLoaded(plugin_id) when plugin already in map (soft guard)                 │
│ - PluginNotFound(plugin_id) in a new get_or_error() helper                         │
│                                                                                    │
│ api.rs — Expose count()                                                            │
│                                                                                    │
│ Add get_file_watcher_count Tauri command calling watcher_registry.count().await.   │
│                                                                                    │
│ Warnings resolved: 11                                                              │
│                                                                                    │
│ - manager.rs: unregister_event_listener, get_event_listeners, emit_event,          │
│ sandbox_registry (4)                                                               │
│ - loader.rs: ManifestNotFound, InvalidManifest, AlreadyLoaded, PluginNotFound (4)  │
│ - loader.rs: unload, verify_dependencies (2)                                       │
│ - api.rs: count (1)                                                                │
│                                                                                    │
│ ---                                                                                │
│ Phase 3: Sandbox Resources & Worker Lifecycle                                      │
│                                                                                    │
│ Goal: Wire resource stats, limits, sandbox listing, worker shutdown,               │
│ WorkerRegistry.                                                                    │
│                                                                                    │
│ sandbox.rs — Real check_resource_limits()                                          │
│                                                                                    │
│ Implement actual limit checking using all fields:                                  │
│ pub fn check_resource_limits(&self) -> Result<(), PluginError> {                   │
│     let stats = self.get_resource_stats();                                         │
│     if stats.memory_used > self.resource_limits.max_memory {                       │
│         return Err(PluginError::MemoryLimitExceeded { used: stats.memory_used,     │
│ limit: self.resource_limits.max_memory });                                         │
│     }                                                                              │
│     if stats.operations_count > self.resource_limits.max_operations {              │
│         return Err(PluginError::RateLimitExceeded { current:                       │
│ stats.operations_count, limit: self.resource_limits.max_operations });             │
│     }                                                                              │
│     Ok(())                                                                         │
│ }                                                                                  │
│                                                                                    │
│ This uses MemoryLimitExceeded, RateLimitExceeded, max_memory, max_operations.      │
│                                                                                    │
│ sandbox.rs — Getters for fields + SerializationError/Timeout                       │
│                                                                                    │
│ - Add pub fn id(&self) -> &str, pub fn capabilities(&self) -> &PluginCapabilities, │
│  pub fn resource_limits(&self) -> &ResourceLimits                                  │
│ - In call_hook(), use PluginError::SerializationError when serde_json::to_string   │
│ fails for args                                                                     │
│ - In execute()/call_hook(), wrap worker calls with tokio timeout →                 │
│ PluginError::Timeout { duration } on expiry                                        │
│                                                                                    │
│ sandbox.rs — Cleanup sends Shutdown                                                │
│                                                                                    │
│ Add send_shutdown() to PluginWorker (sends WorkerMessage::Shutdown via sender).    │
│ Call self.worker.send_shutdown() in PluginSandbox::cleanup().                      │
│                                                                                    │
│ worker.rs — Getters for fields                                                     │
│                                                                                    │
│ - pub fn id(&self) -> &str — reads self.id                                         │
│ - pub fn capabilities(&self) -> &PluginCapabilities — reads self.capabilities      │
│ - pub fn resource_limits(&self) -> &ResourceLimits — reads self.resource_limits    │
│ - handle is already used in shutdown() method                                      │
│                                                                                    │
│ worker.rs — WorkerRegistry integration                                             │
│                                                                                    │
│ Create WorkerRegistry in main.rs setup as managed state. Use create_worker()       │
│ tracking alongside sandbox creation, remove_worker() on deactivate, and            │
│ get_worker()/get_worker_mut() in resource stats command. shutdown_all() called on  │
│ app exit hook. WorkerAlreadyExists error from create_worker().                     │
│                                                                                    │
│ main.rs — New commands                                                             │
│                                                                                    │
│ - list_active_sandboxes → calls sandbox_registry.list_sandboxes()                  │
│ - get_plugin_resource_stats(plugin_id) → calls sandbox.check_resource_limits() +   │
│ sandbox.get_resource_stats(), uses ResourceStats                                   │
│                                                                                    │
│ Warnings resolved: 18 (remaining sandbox/worker)                                   │
│                                                                                    │
│ - sandbox.rs: id, capabilities, resource_limits fields (3)                         │
│ - sandbox.rs: get_resource_stats, check_resource_limits, ResourceStats,            │
│ list_sandboxes (4)                                                                 │
│ - sandbox.rs: SerializationError, Timeout, MemoryLimitExceeded, RateLimitExceeded, │
│  WorkerAlreadyExists (5)                                                           │
│ - worker.rs: Shutdown, id, capabilities, resource_limits, handle fields (5)        │
│ - worker.rs: shutdown, WorkerRegistry + 6 methods (7... but counted as 1 struct +  │
│ 6 methods)                                                                         │
│                                                                                    │
│ ---                                                                                │
│ Phase 4: Capability Runtime Management                                             │
│                                                                                    │
│ Goal: Wire capability mutation methods and preset constructors.                    │
│                                                                                    │
│ manager.rs — Capability tier in PluginStatus                                       │
│                                                                                    │
│ In get_status(), compute a capability tier using presets and is_subset_of():       │
│ let tier = if caps.is_subset_of(&PluginCapabilities::none()) { "sandboxed" }       │
│     else if caps.is_subset_of(&PluginCapabilities::workspace_read()) { "read-only" │
│  }                                                                                 │
│     else if caps.is_subset_of(&PluginCapabilities::workspace_read_write()) {       │
│ "read-write" }                                                                     │
│     else { "full" };                                                               │
│                                                                                    │
│ This uses none(), workspace_read(), workspace_read_write(), first_party(),         │
│ is_subset_of().                                                                    │
│                                                                                    │
│ main.rs — grant_plugin_capability command                                          │
│                                                                                    │
│ Takes plugin_id + capability changes (domain to add, command to allow/disallow).   │
│ Uses:                                                                              │
│ - caps.network.add_domain(domain) — adds network access                            │
│ - caps.commands.allow_command(cmd) / disallow_command(cmd) — mutates command       │
│ access                                                                             │
│ - CommandCapability::new(allowlist) — constructs from input                        │
│ - PluginCapabilities::merge() — merges granted capabilities with existing          │
│ - UiCapability::all() / basic() — used as presets in the "template" parameter      │
│                                                                                    │
│ Warnings resolved: all remaining capabilities                                      │
│                                                                                    │
│ - capabilities.rs: add_domain (1)                                                  │
│ - capabilities.rs: CommandCapability::new, allow_command, disallow_command (3)     │
│ - capabilities.rs: UiCapability::all, basic (2)                                    │
│ - capabilities.rs: none, workspace_read, workspace_read_write, first_party, merge, │
│  is_subset_of (6)                                                                  │
│                                                                                    │
│ ---                                                                                │
│ Phase 5: Frontend Integration                                                      │
│                                                                                    │
│ Goal: Surface trust levels, unload action, auto-approve in UI.                     │
│                                                                                    │
│ plugins.ts — Updated types + auto-approve                                          │
│                                                                                    │
│ Add trust and loadedAt to PluginStatus type. In activate(), if trust is            │
│ 'first-party', skip the permission dialog (matches backend                         │
│ auto_grant_permissions()). Add unload(pluginId) method invoking unload_plugin.     │
│                                                                                    │
│ StatusBar.svelte — Trust badges + unload                                           │
│                                                                                    │
│ Show trust badge (shield icon) next to first-party/verified plugins. Add "Unload"  │
│ button to plugin menu that calls pluginsStore.unload(id).                          │
│                                                                                    │
│ ---                                                                                │
│ Implementation Order                                                               │
│                                                                                    │
│ Phase 1 (Trust) → Phase 2 (Events/Lifecycle) → Phase 3 (Sandbox/Worker) → Phase 4  │
│ (Capabilities) → Phase 5 (Frontend)                                                │
│                                                                                    │
│ Sequential because each phase builds on previous integration points.               │
│                                                                                    │
│ ---                                                                                │
│ File Summary                                                                       │
│                                                                                    │
│ Modified Files                                                                     │
│ File: src-tauri/src/plugin_system/manager.rs                                       │
│ Key Changes: PluginStatus fields, trust checks in activate, event cleanup in       │
│   deactivate, emit_event calls, unload(), verify_dependencies,                     │
│   sandbox_registry usage, capability tier                                          │
│ ────────────────────────────────────────                                           │
│ File: src-tauri/src/plugin_system/loader.rs                                        │
│ Key Changes: Use all LoaderError variants, signature validation, is_first_party    │
│ usage                                                                              │
│ ────────────────────────────────────────                                           │
│ File: src-tauri/src/plugin_system/sandbox.rs                                       │
│ Key Changes: Field getters, real check_resource_limits, SerializationError/Timeout │
│                                                                                    │
│   usage, cleanup shutdown                                                          │
│ ────────────────────────────────────────                                           │
│ File: src-tauri/src/plugin_system/worker.rs                                        │
│ Key Changes: send_shutdown(), field getters                                        │
│ ────────────────────────────────────────                                           │
│ File: src-tauri/src/main.rs                                                        │
│ Key Changes: TrustVerifier + WorkerRegistry state, ~8 new Tauri commands, trust    │
│ check                                                                              │
│    in activate flow                                                                │
│ ────────────────────────────────────────                                           │
│ File: src/lib/stores/plugins.ts                                                    │
│ Key Changes: Updated types, auto-approve first-party, unload method                │
│ ────────────────────────────────────────                                           │
│ File: src/components/StatusBar.svelte                                              │
│ Key Changes: Trust badges, unload button                                           │
│ New Tauri Commands (8)                                                             │
│ Command: unload_plugin                                                             │
│ Wires Up: loader.unload()                                                          │
│ ────────────────────────────────────────                                           │
│ Command: get_plugin_event_listeners                                                │
│ Wires Up: manager.get_event_listeners()                                            │
│ ────────────────────────────────────────                                           │
│ Command: get_file_watcher_count                                                    │
│ Wires Up: FileWatcherRegistry::count()                                             │
│ ────────────────────────────────────────                                           │
│ Command: list_active_sandboxes                                                     │
│ Wires Up: SandboxRegistry::list_sandboxes()                                        │
│ ────────────────────────────────────────                                           │
│ Command: get_plugin_resource_stats                                                 │
│ Wires Up: sandbox.get_resource_stats() + check_resource_limits()                   │
│ ────────────────────────────────────────                                           │
│ Command: grant_plugin_capability                                                   │
│ Wires Up: merge(), add_domain(), allow/disallow_command()                          │
│ ────────────────────────────────────────                                           │
│ Command: add_trusted_key                                                           │
│ Wires Up: TrustVerifier::add_trusted_key()                                         │
│ ────────────────────────────────────────                                           │
│ Command: remove_trusted_key                                                        │
│ Wires Up: TrustVerifier::remove_trusted_key()                                      │
│ No New Dependencies                                                                │
│                                                                                    │
│ ---                                                                                │
│ Verification                                                                       │
│                                                                                    │
│ cd src-tauri && cargo check 2>&1 | grep "warning:"  # Target: 0 warnings           │
│ cd src-tauri && cargo test                           # All existing + new tests    │
│ pass                                                                               │
│ npm run build                                        # 0 errors                    │
│ npm test                                             # All tests pass              │
│ npx tauri dev                                        # Plugins                     │
│ discover/load/activate with trust info                                             │
╰────────────────────────────────────────────────────────────────────────────────────╯
