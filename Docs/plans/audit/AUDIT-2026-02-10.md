# 2026-02-10 Security Audit Report

## Findings (by impact)

---

### High
1. High - Filesystem sandbox boundary can be bypassed in Deno ops
   src-tauri/src/plugin_system/capabilities.rs:34, src-tauri/src/plugin_system/capabilities.rs:47 use string
   starts_with for path checks. That allows prefix confusion (/workspace2 matching /workspace) and weak scoped checks
   (allowed="/workspace/read" matches /workspace/readme).
   Also used by plugin ops at src-tauri/src/plugin_system/ops.rs:77, src-tauri/src/plugin_system/ops.rs:126, src-
2. High - Trust/signature model is effectively non-cryptographic
   src-tauri/src/plugin_system/trust.rs:47 and src-tauri/src/plugin_system/trust.rs:76 only check non-empty signature
+ key in set.
   plugin metadata.
   src-tauri/src/main.rs:77 only verifies signatures when Some(sig); missing signature does not fail.
   to manifest.
1. High - plugin_* Tauri filesystem APIs are bound to wrong root
   api.rs:469, src-tauri/src/plugin_system/api.rs:538 use app_data_dir() as workspace root.
   But plugin manager/worker root is project root in dev: src-tauri/src/main.rs:691, src-tauri/src/main.rs:355.
   This causes capability mismatches and denies expected workspace access in development and possibly mixed runtime
   behavior in release.

---

## Medium

1. Medium - Editor Tauri plugin API path looks broken/scaffolded
   src-tauri/src/plugin_system/api.rs:1029 and src-tauri/src/plugin_system/api.rs:1107 emit plugin:editor:get_* events
   and wait for response events (:1019, :1097), but there are no matching frontend listeners in src/ (only occurrences
   are in this backend file). Likely always times out in real usage.
2. Medium - Command execution policy not fully enforced
   src-tauri/src/plugin_system/api.rs:776 accepts unvalidated cwd, enabling execution anywhere on disk if command is
   allowlisted.
   src-tauri/src/plugin_system/api.rs:86 registry keys by watch_id only.
   plugin/client can remove another plugin’s watch.
3. Medium - grant_plugin_capability appears non-functional
   src-tauri/src/main.rs:236 computes merged capabilities and returns JSON (:298) but never writes back to manager/
   loader state. This is likely a misleading API surface.
4. Medium - Plugin commands are not integrated end-to-end
   Plugin command metadata exists in manifests (plugins/git/plugin.toml) and is parsed (src-tauri/src/plugin_system/
   loader.rs:63), but UI command registration is only built-ins (src/App.svelte:191).
   Unhandled commands fall through to log (src/App.svelte:282), so plugin command execution path is incomplete.

---

## Low

1. Low - Windows path handling inconsistency in Save As
   src/lib/stores/editor.ts:395 uses split('/') for filename extraction, unlike robust path split earlier at src/lib/
   stores/editor.ts:211 (split(/[\\/]/)), causing incorrect tab names on Windows.
2. Low - Plugin entrypoint path is not constrained to plugin dir
   src-tauri/src/plugin_system/manager.rs:227 joins manifest.main directly and reads it (:228) without canonical

---

## Notes

I assumed Tauri invoke surface is reachable only from trusted frontend code; if any XSS lands in the webview, several medium issues become high.

---

### Validation run

+ npm run test -- --run passed (316 tests).
+ cargo test -q passed (178 tests).

---

## Remediation Plan (Impact/Effort Ordered)

1. P0: Fix filesystem sandbox boundary checks
   Impact: Critical, Effort: Medium
2. Add canonical path boundary helpers (Path-based, segment-safe) in src-tauri/src/plugin_system/capabilities.rs.
3. Replace string starts_with checks in can_read/can_write.
4. Update callers in src-tauri/src/plugin_system/ops.rs and src-tauri/src/plugin_system/api.rs to use canonicalized
   PathBuf consistently.
5. Add regression tests for /workspace vs /workspace2, and scoped /read vs /readme.
6. P0: Unify workspace-root source for plugin capability enforcement
   Impact: Critical, Effort: Small
   Patch:
7. Introduce one authoritative workspace root provider (from app state) in src-tauri/src/main.rs.
8. Replace app_data_dir() usage in plugin API filesystem commands in src-tauri/src/plugin_system/api.rs with the same
   root used by manager/workers.
9. Add integration tests for dev/release root behavior.
10. P0: Harden trust/signature flow
   Impact: Critical, Effort: Medium
   Patch:
   verification or explicitly enforce “not implemented = fail closed.”
11. In src-tauri/src/plugin_system/loader.rs, stop overriding declared trust levels in a way that discards verified.
12. Remove stub-signature behavior for first-party plugins (or gate with explicit build-time/dev-only flag).
13. In src-tauri/src/main.rs:activate_plugin, fail activation when signature is required but absent/invalid.
14. Add tests for required-signature missing, invalid, and valid cases.
   Impact: High, Effort: Medium
   Patch:
15. Enforce require_confirmation in src-tauri/src/plugin_system/api.rs instead of skipping.
16. Restrict cwd to workspace/scoped paths.
17. Add command timeout and cancellation handling.
18. Keep allowlist strict (no path-based binary execution unless explicitly allowed).
19. P1: Enforce watch ownership in watcher registry
   Impact: High, Effort: Small
   Patch:
20. Change watcher registry value to store { plugin_id, watcher } in src-tauri/src/plugin_system/api.rs.
21. In plugin_unwatch_path, require caller plugin_id to match owner.
22. P1: Resolve broken/scaffolded editor plugin Tauri API path
   Impact: High, Effort: Medium
   plugin_system/api.rs.
23. If keeping event path, scope request/response by plugin and request ID.
24. P2: Wire plugin manifest commands into UI command registry
   Impact: Medium, Effort: Medium
   Patch:
25. Parse and expose manifest commands from backend status payload.
26. Register/unregister plugin commands in src/lib/stores/plugins.ts on plugin load/unload.
27. Execute routed plugin commands (not just built-ins) in src/App.svelte.
28. Add tests in src/lib/stores/plugins.test.ts and command palette behavior tests.
29. P3: Contain plugin entrypoint path
30. In src-tauri/src/plugin_system/manager.rs, canonicalize manifest.main target.
31. Add traversal tests (../, absolute path).
32. P3: Fix Windows Save As filename parsing
   Impact: Low, Effort: Tiny
   Patch:
33. In src/lib/stores/editor.ts, replace split('/') with cross-platform split (/[\\/]/) at Save As path handling.
34. Add unit test for Windows-style path.

---

### Exact Patch Sequence (commit order)

1. fix(security): harden filesystem capability boundary checks
2. fix(core): unify workspace root for plugin APIs
3. fix(security): enforce trust/signature verification fail-closed
4. fix(security): enforce command confirmation cwd bounds and timeouts
5. fix(security): bind file watchers to plugin ownership
6. refactor(plugin-api): replace editor event roundtrip with shared state
7. feat(plugins): register and execute manifest-defined plugin commands
8. fix(security): constrain plugin entrypoint path to plugin dir
9. fix(editor): normalize windows path parsing in save-as

---

### Validation Gate After Each Commit

1. npm run check
2. npm run test -- --run
3. cargo test -q

### Final release gate

1. npm run lint
2. npm run test:coverage
3. npm run test:rust
4. npm run build
5. npm run tauri:build

---
